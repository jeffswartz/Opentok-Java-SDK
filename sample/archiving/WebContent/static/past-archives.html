<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Archiving Sample</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width">

  <link rel="stylesheet" href="bs/css/bootstrap.min.css">
  <link rel="stylesheet" href="bs/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="css/sample.css">
  
  <script type="text/javascript" src="js/jquery.js"></script>
  <script type="text/javascript" src="config.js"></script>
</head>
<body>

<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <a class="navbar-brand" href="index.html">Archiving Sample App</a>
  </div>

</nav>
  <script type="text/javascript">
    var page = 1;
    var perPage = 5;
    var actionCount = 0;
    var totalCount = 0;

    // gets the current page
    var hash = window.location.hash;
    if (hash) {
      var number = hash.substr(1);
      var intRegex = /^\d+$/;
      if(intRegex.test(number)) {
         page = parseInt(number, 10);
      }
    }
    
    $(document).ready(function() {
      // set the next and prev buttons
      $("a.pull-left").click(function() {
        if (page > 1) {
          if (page - 1 > Math.floor(totalCount / perPage)) {
            page = Math.floor(totalCount / perPage) + 1;
          } else {
            page = page-1;
          }
          setTimeout(fetchArchives, 1);
        }
      }).attr("href", "#" + (page - 1)).hide();

      $("a.pull-right").click(function() {
        if (page * perPage < totalCount) {
          page = page+1;
          setTimeout(fetchArchives, 1);
        }
      }).attr("href", "#" + (page + 1)).hide();

      // query for the initial archives
      fetchArchives();
    });

    function fetchArchives() {
      actionCount++;

      var offset = (page - 1) * perPage;
      var url = Config.listArchivesURL + "?offset=" + offset + "&count=" + perPage;

      var currAction = actionCount;

      // change the links
      var updateLinks = function() {
        $("a.pull-left").attr("href", function() {
          if (page - 1 > Math.floor(totalCount / perPage)) {
            return "#" + (Math.floor(totalCount / perPage) + 1);
          } else {
            return "#" + (page - 1)
          }
        });

        $("a.pull-right").attr("href", function() {
          return "#" + (page + 1)
        });

        if (page > 1) {
          $("a.pull-left").show();
        } else {
          $("a.pull-left").hide();
        }

        if (page * perPage < totalCount) {
          $("a.pull-right").show();
        } else {
          $("a.pull-right").hide();
        }
      }

      updateLinks();

      $.get(url, function(data) {

        // discard action if we did something else
        if (currAction != actionCount) {
          return;
        }

        if (data.count) {
          totalCount = data.count;
          updateLinks();
        }

        if (data.count == 0) {
          $("table").remove();
          $(".panel-body").html('<p>There are no archives currently. Try making one in the <a href="host-view.php">host view</a>.</p>');
        } else {
          displayArchives(data);
        }
      }, "json");
    }

    function displayArchives(data) {
      // clear out the table first
      $("table > tbody").html("");
      for (var i = 0; i < data.items.length; i++) {
        var item = data.items[i];
        var tr = $("<tr></tr>");
        tr.append("<td>" + (item.url && item.status == "available" ? "<a href='" + item.url + "'>" : "") + (item.name ? item.name : "Untitled") + (item.url && item.status == "available" ? "</a>" : "") + "</td>");
        tr.append("<td>" + dateString(item.createdAt) + " at " + timeString(item.createdAt) + "</td>");
        tr.append("<td>" + item.duration + " seconds</td>");
        tr.append("<td>" + item.status + "</td>");

        if (item.status == "available") {
          var deleteLink = $("<a href='#delete-" + item.id + "'>Delete</a>");
          (function(archiveId) {
            deleteLink.click(function() {
              deleteArchive(archiveId);
              return false;
            })
          })(item.id);
          var deleteTD = $("<td></td>");
          deleteTD.append(deleteLink);
          tr.append(deleteTD);
        } else {
          tr.append("<td></td>");
        }
        $("table > tbody").append(tr);
      }
    }

    function deleteArchive(archiveId) {
      $.ajax({
          url: Config.deleteArchiveURL + "/" + archiveId,
          type: "DELETE",
          success: function(result) {
              fetchArchives();
          }
      });
    }

    function dateString(unixtime) {
      var date = new Date(unixtime);
      return date.getFullYear() + "-" + padzero(date.getMonth()+1) + "-" + padzero(date.getDate());
    }

    function timeString(unixtime) {
      var date = new Date(unixtime);
      return date.getHours()+1 + ":" + padzero(date.getMinutes()) + ":" + padzero(date.getSeconds());
    }

    function padzero(num) {
      return (num < 10) ? "0" + num : num;
    }
  </script>


  <div class="container bump-me">

    <div class="body-content">

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Past Recordings</h3>
        </div>
        <div class="panel-body">
          <table class="table">
            <thead>
              <tr>
                <th>&nbsp;</th>
                <th>Created</th>
                <th>Duration</th>
                <th>Status</th>
                <th>&nbsp;</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <div class="panel-footer">
          <a href="#" class="pull-left">&larr; Newer</a>
          &nbsp;
          <a href="#" class="pull-right">Older &rarr;</a>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript" src="bs/js/bootstrap.min.js"></script>
</body>
</html>
